<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Caixas Batidas</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

    :root{
      --red:#ff3b3b;
      --dark:#0d0d0d;
      --dark-2:#1a1a1a;
      --card:#330000;
    }

    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(145deg, var(--dark), var(--dark-2));
      color: #f5f5f5;
      padding: 20px;
      position: relative;
      min-height: 100vh;
    }

    .header {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:20px;
      flex-direction:column;
      margin-bottom: 10px;
    }
    #logo {
      height: 84px;
      display:block;
    }
    h2 {
      color: var(--red);
      text-align: center;
      margin: 0;
      text-shadow: 0 0 10px var(--red);
    }

    .controls {
      text-align:center;
      margin-top:12px;
    }

    input, button {
      margin: 5px;
      padding: 10px 15px;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      font-family: 'Orbitron', sans-serif;
    }

    input[type="file"] {
      background: #1a1a1a;
      color: #f5f5f5;
    }

    button {
      background: var(--red);
      color: #fff;
      cursor: pointer;
      transition: 0.25s;
    }
    button:hover{
      background:#ff1a1a;
      box-shadow: 0 0 10px var(--red);
    }

    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
      font-size: 14px;
      box-shadow: 0 0 10px #ff3b3b50;
    }

    th, td {
      border: 1px solid #ff3b3b50;
      padding: 10px;
      text-align: left;
    }

    th {
      background: var(--card);
      color: var(--red);
      text-transform: uppercase;
    }

    tr:nth-child(even) {
      background: #1a0000;
    }

    tr:nth-child(odd) {
      background: #0d0000;
    }

    tr:hover {
      background: #4d0000;
      transition: 0.2s;
    }

    #resumo {
      margin-top: 15px;
      text-align: right;
      font-size: 14px;
      color: #ff6666;
    }

    #contadorTotal {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 22px;
      font-weight: bold;
      color: var(--red);
      text-shadow: 0 0 10px var(--red);
      z-index: 1000;
    }
  </style>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="header">
    <!-- Coloque o arquivo logo.png na mesma pasta do HTML -->
    <img id="logo" src="logo.png" alt="Logo (coloque logo.png na mesma pasta)">
    <h2>Caixas Batidas</h2>
    <div class="controls">
      <input type="file" id="fileInput" accept=".csv">
      <button id="baixarPDF">Baixar PDF Completo</button>
      <button id="baixarTotaisPDF">Baixar PDF Totais</button>
      <button id="resetAcumulado" title="Resetar total acumulado" style="background:#333;color:#fff;margin-left:8px;">Resetar Total</button>
    </div>
  </div>

  <div id="contadorTotal">Total: 0</div>

  <table id="tabela"></table>
  <div id="resumo"></div>

  <script>
    // --- Variáveis principais
    let dadosOriginais = [];
    let dadosFiltrados = [];
    const camposDesejados = ["id_cto", "id_os", "assunto", "colaborador", "data"];
    let totalAcumulado = 0;

    // Para inserir logo no PDF
    let logoDataURL = null;

    function preloadLogoToDataURL() {
      const imgEl = document.getElementById('logo');
      if (!imgEl) return;
      if (imgEl.complete && imgEl.naturalWidth !== 0) convertImgToDataURL(imgEl);
      else {
        imgEl.addEventListener('load', () => convertImgToDataURL(imgEl));
        imgEl.addEventListener('error', () => console.warn('Erro ao carregar logo.png — verifique o caminho/nome.'));
      }
    }

    function convertImgToDataURL(imgEl) {
      try {
        const canvas = document.createElement('canvas');
        canvas.width = imgEl.naturalWidth;
        canvas.height = imgEl.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(imgEl, 0, 0);
        logoDataURL = canvas.toDataURL('image/png');
      } catch (err) {
        console.warn('Não foi possível converter a imagem para DataURL:', err);
        logoDataURL = null;
      }
    }

    preloadLogoToDataURL();

    // --- Leitura do CSV
    document.getElementById("fileInput").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();

      reader.onload = function(e) {
        const texto = e.target.result;
        processarCSV(texto);
      };

      reader.readAsText(file, 'UTF-8');
    });

    function processarCSV(texto) {
      // Suavizar quebras CRLF/LF e ignorar linhas vazias
      const linhas = texto.split(/\r?\n/).map(l => l.trim()).filter(l => l);
      if (linhas.length === 0) {
        alert('CSV vazio ou inválido.');
        return;
      }

      const cabecalho = linhas[0].split(",").map(c => c.trim().toLowerCase());
      const dados = linhas.slice(1).map(linha => linha.split(",").map(c => c.trim()));

      const indices = camposDesejados.map(campo => cabecalho.indexOf(campo));
      const faltantes = [];
      indices.forEach((idx, i) => { if (idx === -1) faltantes.push(camposDesejados[i]); });
      if (faltantes.length) {
        alert('Campos não encontrados no CSV: ' + faltantes.join(', ') + '. Verifique o cabeçalho.');
        return;
      }

      dadosOriginais = dados.map(linha => indices.map(i => linha[i]));
      aplicarFiltro();
    }

    function aplicarFiltro() {
      const grupos = {};
      dadosOriginais.forEach(linha => {
        const assunto = linha[2] ?? '';
        if (!grupos[assunto]) grupos[assunto] = [];
        grupos[assunto].push(linha);
      });

      const assuntosOrdenados = Object.keys(grupos).sort();
      dadosFiltrados = assuntosOrdenados.flatMap(assunto => grupos[assunto]);

      montarTabela(camposDesejados, dadosFiltrados);

      // Atualiza resumo por assunto (somente do CSV atual)
      const resumoDiv = document.getElementById("resumo");
      let resumoTexto = assuntosOrdenados.map(assunto => `${assunto}: ${grupos[assunto].length}`).join(" | ");
      resumoDiv.textContent = resumoTexto;

      // Soma total do CSV carregado ao total acumulado
      const totalCSV = Object.values(grupos).reduce((acc, arr) => acc + arr.length, 0);
      totalAcumulado += totalCSV;

      // Atualiza contador animado
      animarContador(totalAcumulado);
    }

    function montarTabela(cabecalho, dados) {
      const tabela = document.getElementById("tabela");
      tabela.innerHTML = "";

      let thead = "<tr>";
      cabecalho.forEach(c => thead += `<th>${c}</th>`);
      thead += "</tr>";
      tabela.innerHTML += thead;

      dados.forEach(linha => {
        let row = "<tr>";
        linha.forEach(col => row += `<td>${col ?? ''}</td>`);
        row += "</tr>";
        tabela.innerHTML += row;
      });
    }

    function animarContador(valorFinal) {
      const contador = document.getElementById("contadorTotal");
      let valorAtual = parseInt(contador.textContent.replace(/\D/g, '')) || 0;
      // evita passo 0
      const diferenca = valorFinal - valorAtual;
      if (diferenca === 0) return;
      const duracaoMs = 700; // duração da animação
      const start = performance.now();

      function step(now) {
        const progress = Math.min(1, (now - start) / duracaoMs);
        contador.textContent = `Total: ${Math.round(valorAtual + diferenca * progress)}`;
        if (progress < 1) {
          requestAnimationFrame(step);
        } else {
          contador.textContent = `Total: ${valorFinal}`;
        }
      }
      requestAnimationFrame(step);
    }

    document.getElementById('resetAcumulado').addEventListener('click', () => {
      if (!confirm('Resetar total acumulado para zero?')) return;
      totalAcumulado = 0;
      animarContador(0);
    });

    // adiciona logo se disponível
    function addLogoToDocIfAvailable(doc, x = 14, y = 14, w = 36, h = 36) {
      try {
        if (logoDataURL) {
          doc.addImage(logoDataURL, 'PNG', x, y, w, h);
          return { added: true, x, y, w, h };
        }
      } catch (err) {
        console.warn('Não foi possível adicionar o logo ao PDF:', err);
      }
      return { added: false, x, y, w, h };
    }

    // tenta formatar várias entradas de data (ISO, "YYYY-MM-DD HH:MM:SS", "DD/MM/YYYY")
    function formatarDataBR(dataStr) {
      if (!dataStr) return '';
      const s = String(dataStr).trim();
      // se tem 'T' (ISO)
      if (s.includes('T')) {
        const datePart = s.split('T')[0];
        const p = datePart.split('-');
        if (p.length === 3) return `${p[2]}/${p[1]}/${p[0]}`;
      }
      // se tem espaço "YYYY-MM-DD HH:MM:SS"
      if (s.includes(' ')) {
        const datePart = s.split(' ')[0];
        const p = datePart.split('-');
        if (p.length === 3) return `${p[2]}/${p[1]}/${p[0]}`;
      }
      // se já está com barras (assume formato BR ou MDY)
      if (s.includes('/')) {
        const p = s.split('/'); // dd/mm/yyyy ou yyyy/mm/dd
        if (p.length === 3) {
          if (p[0].length === 4) return `${p[2]}/${p[1]}/${p[0]}`; // yyyy/mm/dd => dd/mm/yyyy
          return `${p[0]}/${p[1]}/${p[2]}`; // assume já dd/mm/yyyy
        }
      }
      // fallback: tentar extrair trecho de 4 dígitos de ano
      const match = s.match(/(\d{4})/);
      if (match) {
        // tenta extrair yyyy-mm-dd com regex
        const m2 = s.match(/(\d{4})-(\d{2})-(\d{2})/);
        if (m2) return `${m2[3]}/${m2[2]}/${m2[1]}`;
      }
      return s;
    }

    // --- PDF Completo
    document.getElementById("baixarPDF").addEventListener("click", () => {
      if (dadosFiltrados.length === 0) {
        alert("Nenhum dado para exportar!");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // configura cabeçalho (logo + infos)
      const logoInfo = addLogoToDocIfAvailable(doc, 14, 14, 36, 36);
      const logoY = logoInfo.y;
      const logoH = logoInfo.h;

      // calcular posição vertical do bloco de texto para centralizar ao lado do logo
      const linesInfo = [
        "Av Joao Correa, 1365 - Centro - Sapiranga/RS",
        "CEP: 93800-000   Tel: (51) 3039-2203",
        "E-mail: giga30392203@gmail.com"
      ];
      const lineHeight = 6; // pt
      const blockHeight = linesInfo.length * lineHeight;
      const textStartY = logoY + (logoH / 2) - (blockHeight / 2) + 4; // +4 para ajuste visual
      const textX = 14 + 36 + 10; // logoX + logoW + gap

      doc.setFontSize(10);
      doc.setTextColor(20);
      linesInfo.forEach((l, i) => doc.text(l, textX, textStartY + i * lineHeight));

      // pega data do primeiro item do CSV e formata (sem hora)
      let dataPrimeiroItem = '';
      if (dadosFiltrados.length > 0) {
        const campoData = dadosFiltrados[0][4]; // posição 'data'
        dataPrimeiroItem = formatarDataBR(campoData);
      }

      // título/descrição centralizado abaixo do cabeçalho
      const headerBottomY = logoY + logoH + 8;
      doc.setFontSize(12);
      doc.setTextColor(80);
      doc.text(`Relatório gerado a partir do CSV - ${dataPrimeiroItem}`, doc.internal.pageSize.getWidth() / 2, headerBottomY, { align: 'center' });

      // tabela (começa abaixo do cabeçalho)
      const bodyData = dadosFiltrados.map(linha => linha);
      doc.autoTable({
        head: [camposDesejados],
        body: bodyData,
        startY: headerBottomY + 8,
        theme: 'grid',
        headStyles: { fillColor: [220, 220, 220], textColor: 0 },
        styles: { fillColor: [255, 255, 255], textColor: 0, lineColor: [150, 150, 150] },
        alternateRowStyles: { fillColor: [245, 245, 245] }
      });

      // resumo ao final da página
      const grupos = {};
      dadosFiltrados.forEach(linha => {
        const assunto = linha[2];
        if (!grupos[assunto]) grupos[assunto] = 0;
        grupos[assunto]++;
      });
      const resumoTexto = Object.keys(grupos).sort().map(a => `${a}: ${grupos[a]}`).join(" | ");

      const pageHeight = doc.internal.pageSize.getHeight();
      const pageWidth = doc.internal.pageSize.getWidth();
      doc.setFontSize(10);
      doc.text(resumoTexto, pageWidth - 14, pageHeight - 10, { align: 'right' });

      doc.save("relatorio_completo.csv.pdf");
    });

    // --- PDF Totais
    document.getElementById("baixarTotaisPDF").addEventListener("click", () => {
      if (dadosFiltrados.length === 0) {
        alert("Nenhum dado para gerar o PDF!");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const logoInfo = addLogoToDocIfAvailable(doc, 14, 14, 36, 36);
      const logoY = logoInfo.y;
      const logoH = logoInfo.h;

      const linesInfo = [
        "Av Joao Correa, 1365 - Centro - Sapiranga/RS",
        "CEP: 93800-000   Tel: (51) 3039-2203",
        "E-mail: giga30392203@gmail.com"
      ];
      const lineHeight = 6;
      const blockHeight = linesInfo.length * lineHeight;
      const textStartY = logoY + (logoH / 2) - (blockHeight / 2) + 4;
      const textX = 14 + 36 + 10;

      doc.setFontSize(10);
      doc.setTextColor(20);
      linesInfo.forEach((l, i) => doc.text(l, textX, textStartY + i * lineHeight));

      // pega data do primeiro item do CSV e formata
      let dataPrimeiroItem = '';
      if (dadosFiltrados.length > 0) {
        const campoData = dadosFiltrados[0][4];
        dataPrimeiroItem = formatarDataBR(campoData);
      }

      const headerBottomY = logoY + logoH + 8;
      doc.setFontSize(12);
      doc.setTextColor(80);
      doc.text(`Resumo total de caixas batidas em ${dataPrimeiroItem}`, doc.internal.pageSize.getWidth() / 2, headerBottomY, { align: 'center' });

      const grupos = {};
      dadosFiltrados.forEach(linha => {
        const assunto = linha[2];
        if (!grupos[assunto]) grupos[assunto] = 0;
        grupos[assunto]++;
      });

      let bodyData = Object.keys(grupos).sort().map(assunto => [assunto, grupos[assunto]]);
      const totalGeral = Object.values(grupos).reduce((acc, val) => acc + val, 0);
      bodyData.push(['Total Geral', totalGeral]);

      doc.autoTable({
        head: [['Assunto', 'Total de Caixas']],
        body: bodyData,
        startY: headerBottomY + 8,
        theme: 'grid',
        headStyles: { fillColor: [255, 59, 59], textColor: 255, fontStyle: 'bold' },
        styles: { fillColor: [30, 30, 30], textColor: 255 },
        alternateRowStyles: { fillColor: [50, 0, 0] },
        tableLineColor: [255, 59, 59],
        tableLineWidth: 0.5,
        didParseCell: function (data) {
          if (data.row.index === bodyData.length - 1) {
            data.cell.styles.fillColor = [255, 0, 0];
            data.cell.styles.textColor = 255;
            data.cell.styles.fontStyle = 'bold';
          }
        }
      });

      doc.save("totais_tabela.csv.pdf");
    });
  </script>
</body>
</html>
